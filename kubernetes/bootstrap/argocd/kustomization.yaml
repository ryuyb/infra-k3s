---
# ArgoCD Installation
# Apply with: GIT_REPO_URL=https://github.com/you/repo.git kustomize build kubernetes/bootstrap/argocd | kubectl apply -f -
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: argocd

resources:
  - https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
  - projects/infrastructure.yaml
  - apps/infrastructure.yaml
  - apps/apps.yaml
  - httproute.yaml

# ConfigMap to hold repo URL (set via envsubst or edit directly)
configMapGenerator:
  - name: argocd-repo-config
    literals:
      - GIT_REPO_URL=${GIT_REPO_URL}
      - DOMAIN=${DOMAIN}

# Replace placeholder in Application specs with actual repo URL
replacements:
  - source:
      kind: ConfigMap
      name: argocd-repo-config
      fieldPath: data.GIT_REPO_URL
    targets:
      - select:
          kind: Application
        fieldPaths:
          - spec.source.repoURL
  - source:
      kind: ConfigMap
      name: argocd-repo-config
      fieldPath: data.DOMAIN
    targets:
      - select:
          kind: HTTPRoute
        fieldPaths:
          - spec.hostnames.0
