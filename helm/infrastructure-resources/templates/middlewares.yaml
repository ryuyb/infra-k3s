{{- range .Values.middlewareNamespaces }}
---
# Authentik Forward Auth middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: authentik-auth
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  forwardAuth:
    address: http://authentik-server.apps.svc.cluster.local/outpost.goauthentik.io/auth/traefik
    trustForwardHeader: true
    authResponseHeaders:
      - X-authentik-username
      - X-authentik-groups
      - X-authentik-email
      - X-authentik-name
      - X-authentik-uid
      - X-authentik-jwt
      - X-authentik-meta-jwks
      - X-authentik-meta-outpost
      - X-authentik-meta-provider
      - X-authentik-meta-app
      - X-authentik-meta-version
---
# Compression middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: compress
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  compress:
    minResponseBodyBytes: 1024
    encodings:
      - gzip
      - br
      - zstd
    excludedContentTypes:
      - text/event-stream
---
# Security headers middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: secure-headers
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
      - HEAD
    accessControlMaxAge: 100
    hostsProxyHeaders:
      - X-Forwarded-Host
    stsSeconds: 63072000
    stsIncludeSubdomains: true
    stsPreload: true
    forceSTSHeader: true
    customFrameOptionsValue: SAMEORIGIN
    contentTypeNosniff: true
    browserXssFilter: true
    referrerPolicy: same-origin
    permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=(), usb=()"
    customResponseHeaders:
      X-Robots-Tag: "none,noindex,nofollow,noarchive,nosnippet,notranslate,noimageindex"
      server: ""
    customRequestHeaders:
      X-Forwarded-Proto: "https"
---
# Rate limiting middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  rateLimit:
    average: 100
    burst: 50
    period: 1s
---
# Cache control middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cache-control
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  headers:
    customResponseHeaders:
      Cache-Control: "public, max-age=3600"
---
# Chain: secure + auth (compress, secure-headers, rate-limit, authentik-auth)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: secure-auth-chain
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  chain:
    middlewares:
      - name: compress
      - name: secure-headers
      - name: rate-limit
      - name: authentik-auth
---
# Chain: secure (compress, secure-headers, rate-limit)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: secure-chain
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  chain:
    middlewares:
      - name: compress
      - name: secure-headers
      - name: rate-limit
---
# headers for oauth2 proxy
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: oauth2-proxy-headers
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  headers:
    sslRedirect: true
    stsSeconds: 315360000
    browserXssFilter: true
    contentTypeNosniff: true
    forceSTSHeader: true
    sslHost: example.com
    stsIncludeSubdomains: true
    stsPreload: true
    frameDeny: true
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: oauth2-proxy-auth
  namespace: {{ . }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  forwardAuth:
    address: http://oauth2-proxy.apps.svc.cluster.local/oauth2/auth
    trustForwardHeader: true
{{- end }}
