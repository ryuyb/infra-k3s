---
# ArgoCD deployment tasks

- name: Install required packages
  apt:
    name:
      - curl
      - git
    state: present
    update_cache: yes

- name: Check if helm is installed
  stat:
    path: /usr/local/bin/helm
  register: helm_binary

- name: Install helm
  block:
    - name: Download helm install script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4
        dest: /tmp/get_helm.sh
        mode: '0700'

    - name: Install helm
      command: /tmp/get_helm.sh
      changed_when: true

    - name: Clean up helm install script
      file:
        path: /tmp/get_helm.sh
        state: absent
  when: not helm_binary.stat.exists

- name: Create argocd namespace
  shell: kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -
  changed_when: false

- name: Add ArgoCD Helm repository
  command: helm repo add argo https://argoproj.github.io/argo-helm
  changed_when: false

- name: Update Helm repositories
  command: helm repo update
  changed_when: false

- name: Create ArgoCD Helm values file
  copy:
    content: |
      global:
        domain: argocd.{{ domain }}

      configs:
        params:
          server.insecure: true

        repositories:
          infra-k3s:
            url: {{ git_repo_url }}
            type: git

      server:
        ingress:
          enabled: false
    dest: /tmp/argocd-values.yaml
    mode: '0644'

- name: Install ArgoCD via Helm
  command: >
    helm upgrade --install argocd argo/argo-cd
    --namespace {{ argocd_namespace }}
    --values /tmp/argocd-values.yaml
    --version {{ argocd_version }}
    --wait
    --timeout 10m
  register: argocd_install
  changed_when: "'has been upgraded' in argocd_install.stdout or 'has been installed' in argocd_install.stdout"

- name: Wait for ArgoCD server to be ready
  command: kubectl wait --for=condition=Available --timeout=300s deployment/argocd-server -n {{ argocd_namespace }}
  changed_when: false

- name: Create temporary directory for manifests
  tempfile:
    state: directory
    suffix: argocd
  register: temp_dir

- name: Clone repository to get App of Apps manifests
  git:
    repo: "{{ git_repo_url }}"
    dest: "{{ temp_dir.path }}/repo"
    version: HEAD
    depth: 1

- name: Create ArgoCD Projects
  shell: |
    for file in {{ temp_dir.path }}/repo/kubernetes/bootstrap/argocd/projects/*.yaml; do
      kubectl apply -f "$file"
    done
  changed_when: false

- name: Deploy infrastructure Application
  template:
    src: infrastructure-app.yaml.j2
    dest: /tmp/infrastructure-app.yaml
    mode: '0644'

- name: Apply infrastructure Application
  command: kubectl apply -f /tmp/infrastructure-app.yaml
  changed_when: false

- name: Deploy apps Application
  template:
    src: apps-app.yaml.j2
    dest: /tmp/apps-app.yaml
    mode: '0644'

- name: Apply apps Application
  command: kubectl apply -f /tmp/apps-app.yaml
  changed_when: false

- name: Create ArgoCD HTTPRoute
  template:
    src: httproute.yaml.j2
    dest: /tmp/argocd-httproute.yaml
    mode: '0644'

- name: Apply ArgoCD HTTPRoute
  command: kubectl apply -f /tmp/argocd-httproute.yaml
  changed_when: false

- name: Get ArgoCD admin password
  shell: kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d
  register: argocd_password
  changed_when: false
  retries: 10
  delay: 5
  until: argocd_password.rc == 0

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ temp_dir.path }}"
    - /tmp/argocd-values.yaml
    - /tmp/infrastructure-app.yaml
    - /tmp/apps-app.yaml
    - /tmp/argocd-httproute.yaml

- name: Display ArgoCD access information
  debug:
    msg:
      - "ArgoCD deployed successfully via Helm!"
      - "Access ArgoCD UI:"
      - "  Via HTTPRoute: https://argocd.{{ domain }}"
      - "  Via port-forward: kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "  Local URL: https://localhost:8080"
      - "  Username: admin"
      - "  Password: {{ argocd_password.stdout }}"
      - ""
      - "App of Apps deployed:"
      - "  - infrastructure: kubernetes/infrastructure"
      - "  - apps: kubernetes/apps"
