---
# ArgoCD deployment tasks

- name: Install required packages
  apt:
    name:
      - curl
      - git
    state: present
    update_cache: yes

- name: Check if argocd CLI is installed
  stat:
    path: /usr/local/bin/argocd
  register: argocd_cli

- name: Install ArgoCD CLI
  block:
    - name: Download ArgoCD CLI
      get_url:
        url: https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        dest: /tmp/argocd
        mode: '0755'

    - name: Install ArgoCD CLI to /usr/local/bin
      copy:
        src: /tmp/argocd
        dest: /usr/local/bin/argocd
        mode: '0755'
        remote_src: yes

    - name: Clean up downloaded file
      file:
        path: /tmp/argocd
        state: absent
  when: not argocd_cli.stat.exists

- name: Check if helm is installed
  stat:
    path: /usr/local/bin/helm
  register: helm_binary

- name: Install helm
  block:
    - name: Download helm install script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4
        dest: /tmp/get_helm.sh
        mode: '0700'

    - name: Install helm
      command: /tmp/get_helm.sh
      changed_when: true

    - name: Clean up helm install script
      file:
        path: /tmp/get_helm.sh
        state: absent
  when: not helm_binary.stat.exists

- name: Create argocd namespace
  shell: kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Check for local SOPS age key
  ansible.builtin.stat:
    path: "{{ argocd_sops_age_key_path }}"
  delegate_to: localhost
  become: false
  register: argocd_sops_age_key_stat

- name: Fail if SOPS age key is missing
  ansible.builtin.fail:
    msg: "Missing SOPS age key at {{ argocd_sops_age_key_path }}. Generate it with: age-keygen -o key.txt"
  when: not argocd_sops_age_key_stat.stat.exists

- name: Install SOPS age key into ArgoCD
  block:
    - name: Copy SOPS age key to remote host
      ansible.builtin.copy:
        src: "{{ argocd_sops_age_key_path }}"
        dest: /tmp/argocd-sops-age-key.txt
        mode: "0600"
      no_log: true

    - name: Create/update ArgoCD SOPS age secret
      ansible.builtin.shell: |
        kubectl -n {{ argocd_namespace }} create secret generic argocd-sops-age \
          --from-file=key.txt=/tmp/argocd-sops-age-key.txt \
          --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: false
      no_log: true
  always:
    - name: Remove temporary SOPS age key file
      ansible.builtin.file:
        path: /tmp/argocd-sops-age-key.txt
        state: absent
      no_log: true

- name: Add ArgoCD Helm repository
  command: helm repo add argo https://argoproj.github.io/argo-helm
  changed_when: false

- name: Update Helm repositories
  command: helm repo update
  changed_when: false

- name: Create ArgoCD Helm values file
  copy:
    content: |
      global:
        domain: argocd.{{ domain }}

      configs:
        params:
          server.insecure: true

        repositories:
          infra-k3s:
            url: {{ git_repo_url }}
            type: git
        cm:
          configManagementPlugins: |
            - name: sops
              generate:
                command: ["/bin/sh", "-c"]
                args:
                  - |
                    set -e
                    find . -type f \( -name '*.sops.yaml' -o -name '*.sops.yml' -o -name '*.sops.json' \) -print0 | while IFS= read -r -d '' file; do
                      /custom-tools/sops -d "$file"
                      echo '---'
                    done

      server:
        ingress:
          enabled: false
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: argocd
            labels:
              prometheus: kube-prometheus

      controller:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: argocd
            labels:
              prometheus: kube-prometheus

      repoServer:
        env:
          - name: SOPS_AGE_KEY_FILE
            value: /var/run/argocd/sops/key.txt
          - name: PATH
            value: /custom-tools:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        volumes:
          - name: custom-tools
            emptyDir: {}
          - name: sops-age-key
            secret:
              secretName: argocd-sops-age
        volumeMounts:
          - name: custom-tools
            mountPath: /custom-tools
          - name: sops-age-key
            mountPath: /var/run/argocd/sops
            readOnly: true
        initContainers:
          - name: install-sops
            image: alpine:3.20
            command: ["/bin/sh", "-c"]
            args:
              - |
                set -e
                wget -qO /custom-tools/sops https://github.com/getsops/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64
                chmod +x /custom-tools/sops
            volumeMounts:
              - name: custom-tools
                mountPath: /custom-tools
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: argocd
            labels:
              prometheus: kube-prometheus

      applicationSet:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: argocd
            labels:
              prometheus: kube-prometheus
    dest: /tmp/argocd-values.yaml
    mode: '0644'

- name: Install ArgoCD via Helm
  command: >
    helm upgrade --install argocd argo/argo-cd
    --namespace {{ argocd_namespace }}
    --values /tmp/argocd-values.yaml
    {% if argocd_version %}--version {{ argocd_version }}{% endif %}
    --wait
    --timeout 10m
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: argocd_install
  changed_when: "'has been upgraded' in argocd_install.stdout or 'has been installed' in argocd_install.stdout"

- name: Wait for ArgoCD server to be ready
  command: kubectl wait --for=condition=Available --timeout=300s deployment/argocd-server -n {{ argocd_namespace }}
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Create infrastructure AppProject
  template:
    src: infrastructure-project.yaml.j2
    dest: /tmp/infrastructure-project.yaml
    mode: '0644'

- name: Apply infrastructure AppProject
  command: kubectl apply -f /tmp/infrastructure-project.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Deploy secrets Application
  template:
    src: secrets-app.yaml.j2
    dest: /tmp/secrets-app.yaml
    mode: '0644'

- name: Apply secrets Application
  command: kubectl apply -f /tmp/secrets-app.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Deploy infrastructure Application
  template:
    src: infrastructure-app.yaml.j2
    dest: /tmp/infrastructure-app.yaml
    mode: '0644'

- name: Apply infrastructure Application
  command: kubectl apply -f /tmp/infrastructure-app.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Deploy apps Application
  template:
    src: apps-app.yaml.j2
    dest: /tmp/apps-app.yaml
    mode: '0644'

- name: Apply apps Application
  command: kubectl apply -f /tmp/apps-app.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Deploy infrastructure-resources Application
  template:
    src: infrastructure-resources-app.yaml.j2
    dest: /tmp/infrastructure-resources-app.yaml
    mode: '0644'

- name: Apply infrastructure-resources Application
  command: kubectl apply -f /tmp/infrastructure-resources-app.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Install Gateway API CRDs
  shell: kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.1/standard-install.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Wait for Gateway API CRDs to be ready
  shell: kubectl wait --for condition=established --timeout=60s crd/httproutes.gateway.networking.k8s.io
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Create ArgoCD HTTPRoute
  template:
    src: httproute.yaml.j2
    dest: /tmp/argocd-httproute.yaml
    mode: '0644'

- name: Apply ArgoCD HTTPRoute
  command: kubectl apply -f /tmp/argocd-httproute.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Get ArgoCD admin password
  shell: kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: argocd_password
  changed_when: false
  no_log: true
  retries: 10
  delay: 5
  until: argocd_password.rc == 0

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/argocd-values.yaml
    - /tmp/infrastructure-project.yaml
    - /tmp/secrets-app.yaml
    - /tmp/infrastructure-app.yaml
    - /tmp/apps-app.yaml
    - /tmp/argocd-httproute.yaml

- name: Display ArgoCD access information
  debug:
    msg:
      - "ArgoCD deployed successfully via Helm!"
      - "Access ArgoCD UI:"
      - "  Via HTTPRoute: https://argocd.{{ domain }}"
      - "  Via port-forward: kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "  Local URL: https://localhost:8080"
      - "  Username: admin"
      - "  Password: run 'kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d'"
      - ""
      - "App of Apps deployed:"
      - "  - secrets: k8s/secrets"
      - "  - infrastructure: helm/infrastructure"
      - "  - apps: helm/apps"
