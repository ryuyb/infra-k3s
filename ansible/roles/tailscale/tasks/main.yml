---
- name: Check if tailscale is installed
  ansible.builtin.command: "which tailscale"
  register: tailscale_existence
  changed_when: false
  ignore_errors: true

- name: Check if tailscale is already configured
  ansible.builtin.command: "tailscale status"
  register: tailscale_status
  changed_when: false
  ignore_errors: true
  when: tailscale_existence.rc == 0

- name: Install tailscale
  ansible.builtin.shell: "set -o pipefail && curl -fsSL https://tailscale.com/install.sh | sh"
  args:
    executable: /usr/bin/bash
  become: true
  changed_when: true
  when: tailscale_existence.rc != 0

# Tailscale up parameters:
#   --ssh: Enable Tailscale SSH (access nodes via Tailscale without managing SSH keys)
#   --netfilter-mode=off: Don't modify iptables (we manage firewall separately)
#   --accept-dns=false: Don't use Tailscale's DNS (keep system DNS)
#   --timeout=60s: Wait up to 60s for authentication
#   --advertise-tags=tag:ansible: Tag node for ACL policies
#   --auth-key: Pre-authenticated key from Tailscale admin console
- name: Provision tailscale node
  block:
    - name: Create temp file for Tailscale auth key
      ansible.builtin.tempfile:
        state: file
        suffix: tailscale_authkey
      register: tailscale_authkey_file
      no_log: true

    - name: Write Tailscale auth key to temp file
      ansible.builtin.copy:
        dest: "{{ tailscale_authkey_file.path }}"
        content: "{{ tailscale_authkey }}"
        mode: "0600"
      no_log: true

    - name: Run tailscale up
      ansible.builtin.shell: >-
        tailscale up
        --ssh
        --netfilter-mode=off
        --accept-dns=false
        --timeout=60s
        --advertise-tags=tag:ansible
        --auth-key="$(cat {{ tailscale_authkey_file.path }})"
      register: tailscale_up_result
      become: true
      ignore_errors: true
      changed_when: tailscale_up_result.rc == 0
      no_log: true
  always:
    - name: Remove temp Tailscale auth key file
      ansible.builtin.file:
        path: "{{ tailscale_authkey_file.path | default('') }}"
        state: absent
      no_log: true
      when: tailscale_authkey_file is defined and tailscale_authkey_file.path is defined
  when: tailscale_status is not defined or (tailscale_status.rc | default(1)) != 0

- name: Fail on tailscale error
  ansible.builtin.fail:
    msg: "Failed to execute tailscale up"
  when:
    - tailscale_up_result is defined
    - tailscale_up_result.rc is defined
    - tailscale_up_result.rc != 0

- name: Read Tailscale status (JSON)
  ansible.builtin.command: "tailscale status --json"
  register: tailscale_status_json
  changed_when: false
  failed_when: false
  when:
    - tailscale_hostname is defined
    - (tailscale_status is defined and (tailscale_status.rc | default(1)) == 0) or (tailscale_up_result is defined and (tailscale_up_result.rc | default(1)) == 0)

- name: Set current Tailscale hostname fact
  ansible.builtin.set_fact:
    tailscale_hostname_current: "{{ (tailscale_status_json.stdout | default('{}') | from_json).Self.HostName | default('') }}"
  when: tailscale_status_json is defined

- name: Set Tailscale hostname
  ansible.builtin.command: "tailscale set --hostname {{ tailscale_hostname }}"
  changed_when: false
  when:
    - tailscale_hostname is defined
    - (tailscale_status is defined and (tailscale_status.rc | default(1)) == 0) or (tailscale_up_result is defined and (tailscale_up_result.rc | default(1)) == 0)
    - tailscale_hostname_current is not defined or tailscale_hostname_current != tailscale_hostname

- name: Get tailscale IPv4 address
  ansible.builtin.command: "tailscale ip -4"
  register: tailscale_ipv4_result
  changed_when: false

- name: Set tailscale_ip fact
  ansible.builtin.set_fact:
    tailscale_ip: "{{ tailscale_ipv4_result.stdout }}"

- name: Ensure all hosts are reachable via Tailscale
  ansible.builtin.command: "tailscale ping --c 1 --timeout 10s {{ item }}"
  loop: "{{ hostvars | dict2items | selectattr('value.tailscale_ip', 'defined') | map(attribute='value.tailscale_ip') | list }}"
  changed_when: false
  when: hostvars | dict2items | selectattr('value.tailscale_ip', 'defined') | list | length > 1
