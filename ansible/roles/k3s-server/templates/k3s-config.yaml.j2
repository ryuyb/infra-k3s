# K3s server configuration
# https://docs.k3s.io/installation/configuration

# Tailscale VPN integration (official, requires K3s v1.27.3+)
vpn-auth: "name=tailscale,joinKey={{ tailscale_authkey }}"
node-external-ip: {{ tailscale_ip }}

# Add Tailscale IP to TLS SAN for valid certificate
tls-san:
  - {{ tailscale_ip }}
  - {{ inventory_hostname }}
{% if k3s_tls_san_extra %}
{% for san in k3s_tls_san_extra %}
  - {{ san }}
{% endfor %}
{% endif %}

# Disable components we don't need or will replace
{% if k3s_disable_traefik %}
disable:
  - traefik
{% endif %}

# Write kubeconfig with correct permissions
write-kubeconfig-mode: "0644"

# Node labels for scheduling
{% if k3s_node_labels %}
node-label:
{% for label in k3s_node_labels %}
  - {{ label }}
{% endfor %}
{% endif %}
