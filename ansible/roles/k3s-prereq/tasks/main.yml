---
# Disable swap (required for Kubernetes)
- name: Disable swap immediately
  ansible.builtin.command: swapoff -a
  changed_when: true
  when: ansible_facts["swaptotal_mb"] > 0

- name: Remove swap from fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '\sswap\s'
    state: absent

# Load required kernel modules
- name: Load kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ k3s_kernel_modules }}"

- name: Persist kernel modules
  ansible.builtin.copy:
    content: |
      {% for module in k3s_kernel_modules %}
      {{ module }}
      {% endfor %}
    dest: /etc/modules-load.d/k3s.conf
    mode: "0644"

# Set sysctl parameters for networking
- name: Set sysctl parameters
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-k3s.conf
    reload: yes
  loop: "{{ k3s_sysctl_params | dict2items }}"
