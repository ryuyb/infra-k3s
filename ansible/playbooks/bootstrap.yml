---
# Bootstrap playbook: Initial VPS setup
# Run this first on new nodes to install base packages, configure firewall, and join Tailscale network
#
# Usage:
#   ansible-playbook playbooks/bootstrap.yml
#   ansible-playbook playbooks/bootstrap.yml --limit master-1

- name: Bootstrap VPS nodes
  hosts: all
  become: true
  gather_facts: false
  pre_tasks:
    - name: Install Python and dependencies
      ansible.builtin.raw: |
        # Install Python3 if not present
        if ! command -v python3 &> /dev/null; then
          if command -v apt-get &> /dev/null; then
            apt-get update && apt-get install -y python3
          elif command -v yum &> /dev/null; then
            yum install -y python3
          elif command -v dnf &> /dev/null; then
            dnf install -y python3
          fi
        fi

        # Install pip3 if not present
        if ! command -v pip3 &> /dev/null; then
          if command -v apt-get &> /dev/null; then
            apt-get install -y python3-pip
          elif command -v yum &> /dev/null; then
            yum install -y python3-pip
          elif command -v dnf &> /dev/null; then
            dnf install -y python3-pip
          fi
        fi

        # Install required Python packages
        if command -v apt-get &> /dev/null; then
          apt-get install -y python3-apt python3-kubernetes
        else
          pip3 install kubernetes
        fi
      changed_when: false

    - name: Gather facts after Python installation
      ansible.builtin.setup:

  roles:
    - common
    - firewall
    - tailscale
