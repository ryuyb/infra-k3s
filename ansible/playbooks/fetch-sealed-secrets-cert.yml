---
# Fetch Sealed Secrets public certificate for offline sealing
# Usage: ansible-playbook ansible/playbooks/fetch-sealed-secrets-cert.yml
- name: Fetch Sealed Secrets Certificate
  hosts: k3s_masters[0]
  gather_facts: false

  vars:
    cert_local_path: "{{ playbook_dir }}/../../sealed-secrets-cert.pem"

  tasks:
    - name: Wait for sealed-secrets controller
      kubernetes.core.k8s_info:
        kind: Deployment
        name: sealed-secrets-controller
        namespace: kube-system
        wait: true
        wait_timeout: 120
        wait_condition:
          type: Available
          status: "True"

    - name: Fetch sealed-secrets certificate via kubectl
      ansible.builtin.shell: |
        kubectl get secret -n kube-system -l sealedsecrets.bitnami.com/sealed-secrets-key \
          -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d
      register: cert_output
      changed_when: false

    - name: Save certificate locally
      ansible.builtin.copy:
        content: "{{ cert_output.stdout }}"
        dest: "{{ cert_local_path }}"
        mode: "0644"
      delegate_to: localhost

    - name: Display certificate path
      ansible.builtin.debug:
        msg: |
          Certificate saved to: {{ cert_local_path }}

          Usage: kubeseal --cert {{ cert_local_path }} --format yaml < secret.yaml > sealedsecret.yaml
