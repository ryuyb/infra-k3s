---
# Setup infrastructure secrets (Velero, External-DNS, Cert-Manager)
# Run after K3s cluster is deployed
#
# Usage:
#   ansible-playbook ansible/playbooks/setup-secrets-infrastructure.yml

- name: Setup infrastructure secrets
  hosts: k3s_masters[0]
  gather_facts: false
  become: false
  vars:
    velero_namespace: velero
    external_dns_namespace: external-dns
    cloudflare_namespaces:
      - external-dns
      - cert-manager
  tasks:
    - name: Check required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'R2_ACCESS_KEY_ID') != ''
          - lookup('env', 'R2_SECRET_ACCESS_KEY') != ''
          - lookup('env', 'VELERO_BUCKET') != ''
          - lookup('env', 'R2_ENDPOINT') != ''
          - lookup('env', 'CLOUDFLARE_API_TOKEN') != ''
        fail_msg: "Missing required environment variables. Set R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, VELERO_BUCKET, R2_ENDPOINT, CLOUDFLARE_API_TOKEN in .envrc.local"
      delegate_to: localhost

    # Velero secrets
    - name: Create velero namespace
      kubernetes.core.k8s:
        name: "{{ velero_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create R2 credentials secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: velero-r2-credentials
            namespace: "{{ velero_namespace }}"
          type: Opaque
          stringData:
            cloud: |
              [default]
              aws_access_key_id={{ lookup('env', 'R2_ACCESS_KEY_ID') }}
              aws_secret_access_key={{ lookup('env', 'R2_SECRET_ACCESS_KEY') }}
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      no_log: true

    - name: Verify Velero secret creation
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: velero-r2-credentials
        namespace: "{{ velero_namespace }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: velero_secret_info

    - name: Display Velero secret status
      ansible.builtin.debug:
        msg: "Velero R2 credentials secret created successfully"
      when: velero_secret_info.resources | length > 0

    # External-DNS namespace
    - name: Create external-dns namespace
      kubernetes.core.k8s:
        name: "{{ external_dns_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create cert-manager namespace
      kubernetes.core.k8s:
        name: cert-manager
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # Cloudflare secrets (shared across namespaces)
    - name: Create Cloudflare API token secrets
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflare-api-token
            namespace: "{{ item }}"
          type: Opaque
          stringData:
            api-token: "{{ lookup('env', 'CLOUDFLARE_API_TOKEN') }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      no_log: true
      loop: "{{ cloudflare_namespaces }}"

    - name: Verify Cloudflare secret creation
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: cloudflare-api-token
        namespace: "{{ item }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: cloudflare_secret_info
      loop: "{{ cloudflare_namespaces }}"

    - name: Display Cloudflare secret status
      ansible.builtin.debug:
        msg: "Cloudflare API token secret created successfully for {{ item.item }}"
      when: item.resources | length > 0
      loop: "{{ cloudflare_secret_info.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "Infrastructure secrets created successfully!"
          - "Velero: velero-r2-credentials in {{ velero_namespace }}"
          - "Cloudflare: cloudflare-api-token in {{ cloudflare_namespaces | join(', ') }}"
