---
# Setup Velero secrets from environment variables
# Run after K3s cluster is deployed
#
# Usage:
#   ansible-playbook playbooks/setup-velero-secrets.yml

- name: Setup Velero R2 credentials
  hosts: k3s_masters[0]
  gather_facts: false
  vars:
    velero_namespace: velero
  tasks:
    - name: Check required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'R2_ACCESS_KEY_ID') != ''
          - lookup('env', 'R2_SECRET_ACCESS_KEY') != ''
          - lookup('env', 'VELERO_BUCKET') != ''
          - lookup('env', 'R2_ENDPOINT') != ''
        fail_msg: "Missing required environment variables. Set R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, VELERO_BUCKET, R2_ENDPOINT in .envrc.local"
      delegate_to: localhost

    - name: Create velero namespace
      kubernetes.core.k8s:
        name: "{{ velero_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: "{{ lookup('env', 'HOME') }}/.kube/config"
      delegate_to: localhost

    - name: Create R2 credentials secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: velero-r2-credentials
            namespace: "{{ velero_namespace }}"
          type: Opaque
          stringData:
            cloud: |
              [default]
              aws_access_key_id={{ lookup('env', 'R2_ACCESS_KEY_ID') }}
              aws_secret_access_key={{ lookup('env', 'R2_SECRET_ACCESS_KEY') }}
      environment:
        KUBECONFIG: "{{ lookup('env', 'HOME') }}/.kube/config"
      delegate_to: localhost
      no_log: true

    - name: Verify secret creation
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: velero-r2-credentials
        namespace: "{{ velero_namespace }}"
      environment:
        KUBECONFIG: "{{ lookup('env', 'HOME') }}/.kube/config"
      delegate_to: localhost
      register: secret_info

    - name: Display success message
      ansible.builtin.debug:
        msg: "Velero R2 credentials secret created successfully"
      when: secret_info.resources | length > 0
