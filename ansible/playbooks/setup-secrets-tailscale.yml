---
# Setup Tailscale Kubernetes Operator secrets
# Run after K3s cluster is deployed
#
# Usage:
#   ansible-playbook ansible/playbooks/setup-secrets-tailscale.yml

- name: Setup Tailscale Operator secrets
  hosts: k3s_masters[0]
  gather_facts: false
  become: false
  vars:
    tailscale_namespace: tailscale
  tasks:
    - name: Verify Tailscale OAuth credentials in Vault
      ansible.builtin.assert:
        that:
          - vault_tailscale_oauth_client_id is defined
          - vault_tailscale_oauth_client_id != ''
          - vault_tailscale_oauth_client_secret is defined
          - vault_tailscale_oauth_client_secret != ''
        fail_msg: "Missing Tailscale OAuth credentials in Vault. Edit ansible/inventory/group_vars/all/vault.yml and add vault_tailscale_oauth_client_id and vault_tailscale_oauth_client_secret"
      delegate_to: localhost

    - name: Create tailscale namespace
      kubernetes.core.k8s:
        name: "{{ tailscale_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create Tailscale Operator OAuth secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: operator-oauth
            namespace: "{{ tailscale_namespace }}"
          type: Opaque
          stringData:
            client_id: "{{ vault_tailscale_oauth_client_id }}"
            client_secret: "{{ vault_tailscale_oauth_client_secret }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      no_log: true

    - name: Verify Tailscale Operator secret creation
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: operator-oauth
        namespace: "{{ tailscale_namespace }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: tailscale_secret_info

    - name: Display Tailscale Operator secret status
      ansible.builtin.debug:
        msg: "Tailscale Operator OAuth secret created successfully"
      when: tailscale_secret_info.resources | length > 0

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "Tailscale Operator secrets created successfully!"
          - "OAuth Secret: operator-oauth in {{ tailscale_namespace }}"
