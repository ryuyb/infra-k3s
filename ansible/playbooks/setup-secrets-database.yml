---
# Setup database secrets (PostgreSQL, pgAdmin4)
# Run after K3s cluster is deployed
#
# Usage:
#   ansible-playbook ansible/playbooks/setup-secrets-database.yml

- name: Setup database secrets
  hosts: k3s_masters[0]
  gather_facts: false
  become: false
  vars:
    database_namespace: database
  tasks:
    - name: Check required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'POSTGRES_PASSWORD') != ''
          - lookup('env', 'PGADMIN_EMAIL') != ''
          - lookup('env', 'PGADMIN_PASSWORD') != ''
        fail_msg: "Missing required environment variables. Set POSTGRES_PASSWORD, PGADMIN_EMAIL, PGADMIN_PASSWORD in .envrc.local"
      delegate_to: localhost

    # PostgreSQL secrets
    - name: Create database namespace
      kubernetes.core.k8s:
        name: "{{ database_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create PostgreSQL credentials secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: postgresql
            namespace: "{{ database_namespace }}"
          type: Opaque
          stringData:
            postgres-password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      no_log: true

    - name: Verify PostgreSQL secret creation
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: postgresql
        namespace: "{{ database_namespace }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: postgresql_secret_info

    - name: Display PostgreSQL secret status
      ansible.builtin.debug:
        msg: "PostgreSQL password secret created successfully"
      when: postgresql_secret_info.resources | length > 0

    # pgAdmin4 secrets
    - name: Create pgAdmin4 credentials secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: pgadmin4
            namespace: "{{ database_namespace }}"
          type: Opaque
          stringData:
            email: "{{ lookup('env', 'PGADMIN_EMAIL') }}"
            password: "{{ lookup('env', 'PGADMIN_PASSWORD') }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      no_log: true

    - name: Verify pgAdmin4 secret creation
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: pgadmin4
        namespace: "{{ database_namespace }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: pgadmin4_secret_info

    - name: Display pgAdmin4 secret status
      ansible.builtin.debug:
        msg: "pgAdmin4 credentials secret created successfully"
      when: pgadmin4_secret_info.resources | length > 0

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "Database secrets created successfully!"
          - "PostgreSQL: postgresql in {{ database_namespace }}"
          - "pgAdmin4: pgadmin4 in {{ database_namespace }}"
