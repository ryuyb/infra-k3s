---
# Setup database secrets (PostgreSQL and application databases)
# Run after K3s cluster is deployed
#
# Usage:
#   ansible-playbook ansible/playbooks/setup-secrets-database.yml

- name: Setup database secrets
  hosts: k3s_masters[0]
  gather_facts: false
  become: false
  vars:
    database_namespace: database
  tasks:
    - name: Check required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'POSTGRES_PASSWORD') != ''
        fail_msg: "Missing required environment variables. Set POSTGRES_PASSWORD in .envrc.local"
      delegate_to: localhost

    # Application database setup
    - name: Warning about PostgreSQL readiness
      ansible.builtin.debug:
        msg:
          - "⚠️  WARNING: PostgreSQL may not be ready yet after ArgoCD deployment"
          - "If database operations fail, wait for PostgreSQL to start and re-run:"
          - "  ansible-playbook ansible/playbooks/setup-secrets-database.yml"
          - "Check PostgreSQL status with:"
          - "  kubectl get pods -n database -l app.kubernetes.io/name=postgresql"

    - name: Install psycopg2 for PostgreSQL module
      ansible.builtin.pip:
        name: psycopg2-binary
        state: present
        executable: pip3
        break_system_packages: true
      become: true

    - name: Load app database configuration
      ansible.builtin.set_fact:
        app_databases_raw: "{{ lookup('file', '../../helm/apps/values.yaml') | from_yaml | json_query('appDatabases') }}"

    - name: Extract namespace from ArgoCD Application definitions
      ansible.builtin.set_fact:
        app_databases: "{{ app_databases | default([]) + [item | combine({'namespace': namespace})] }}"
      vars:
        app_file: "../../helm/apps/templates/{{ item.name }}.yaml"
        app_content: "{{ lookup('file', app_file, errors='ignore') }}"
        app_docs: "{{ app_content | from_yaml_all | list if app_content else [] }}"
        namespace: "{{ app_docs[0].spec.destination.namespace if app_docs | length > 0 else 'apps' }}"
      loop: "{{ app_databases_raw }}"
      loop_control:
        label: "{{ item.name }} -> {{ namespace }}"

    - name: Check app database passwords in Vault
      ansible.builtin.assert:
        that:
          - app_db_passwords[item.name | replace('-', '_')] is defined
          - app_db_passwords[item.name | replace('-', '_')] | length > 0
        fail_msg: "Missing password for {{ item.name }} in Ansible Vault. Run scripts/db/generate-passwords.sh first."
      loop: "{{ app_databases_raw }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Create app namespaces
      kubernetes.core.k8s:
        name: "{{ item.namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      loop: "{{ app_databases }}"
      loop_control:
        label: "{{ item.namespace }}"

    - name: Get PostgreSQL service ClusterIP
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: postgresql
        namespace: "{{ database_namespace }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: postgresql_service

    - name: Set PostgreSQL host
      ansible.builtin.set_fact:
        postgresql_host: "{{ postgresql_service.resources[0].spec.clusterIP }}"

    - name: Create application databases
      community.postgresql.postgresql_db:
        name: "{{ item.database }}"
        state: present
        login_host: "{{ postgresql_host }}"
        login_user: postgres
        login_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
      loop: "{{ app_databases }}"
      loop_control:
        label: "{{ item.database }}"
      no_log: true

    - name: Create application database users
      community.postgresql.postgresql_user:
        name: "{{ item.username }}"
        password: "{{ app_db_passwords[item.name | replace('-', '_')] }}"
        state: present
        login_host: "{{ postgresql_host }}"
        login_user: postgres
        login_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
      loop: "{{ app_databases }}"
      loop_control:
        label: "{{ item.username }}"
      no_log: true

    - name: Grant database privileges
      community.postgresql.postgresql_privs:
        database: "{{ item.database }}"
        roles: "{{ item.username }}"
        privs: ALL
        type: database
        login_host: "{{ postgresql_host }}"
        login_user: postgres
        login_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
      loop: "{{ app_databases }}"
      loop_control:
        label: "{{ item.username }} -> {{ item.database }}"
      no_log: true

    - name: Grant schema privileges
      community.postgresql.postgresql_privs:
        database: "{{ item.database }}"
        roles: "{{ item.username }}"
        privs: ALL
        type: schema
        objs: public
        login_host: "{{ postgresql_host }}"
        login_user: postgres
        login_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
      loop: "{{ app_databases }}"
      loop_control:
        label: "{{ item.username }} -> public schema"
      no_log: true

    - name: Create application database secrets
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ item.name }}-db"
            namespace: "{{ item.namespace }}"
          type: Opaque
          stringData:
            host: "postgresql.database.svc"
            port: "5432"
            database: "{{ item.database }}"
            username: "{{ item.username }}"
            password: "{{ app_db_passwords[item.name | replace('-', '_')] }}"
            connection-string: "postgresql://{{ item.username }}:{{ app_db_passwords[item.name | replace('-', '_')] }}@postgresql.database.svc:5432/{{ item.database }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      loop: "{{ app_databases }}"
      loop_control:
        label: "{{ item.name }}-db in {{ item.namespace }}"
      no_log: true

    - name: Verify application database secrets
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "{{ item.name }}-db"
        namespace: "{{ item.namespace }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      loop: "{{ app_databases }}"
      loop_control:
        label: "{{ item.name }}-db"
      register: app_db_secrets

    - name: Display app database secrets summary
      ansible.builtin.debug:
        msg:
          - "Application database secrets created:"
          - "{% for item in app_databases %}- {{ item.name }}-db in {{ item.namespace }} (database: {{ item.database }}){% if not loop.last %}\n{% endif %}{% endfor %}"
